<% layout('layouts/boilerplate') %>

    <% const variantBySize=new Map((variants || []).map(v=> [v.size, v]));
        const hasSize = s => variantBySize.has(s);
        const filesFor = s => (variantBySize.get(s)?.files|| []);
        %>

        <div class="col-6 offset-3">
            <form action="/products/<%=product._id%>?_method=PUT" method="POST" novalidate class="validated-form"
                enctype="multipart/form-data">
                <div class="mb-3 mt-3">
                    <label class="form-label" for="name">
                        Name
                    </label>
                    <input class="form-control" type="text" id="name" name="product[name]" value="<%=product.name%>"
                        required>
                    <div class="valid-feedback">Looks good!</div>
                </div>

                <div class="input-group mb-3">
                    <label class="form-label" for="price">
                        Price
                    </label>
                    <div class="input-group">
                        <span class="input-group-text">$</span>
                        <input type="text" id="price" name="product[price]" class="form-control" placeholder="0.00"
                            value="<%=product.price%>" required>
                        <div class="valid-feedback">Looks good!</div>
                    </div>
                </div>


                <div class="mt-3 mb-3 d-flex align-items-center gap-3">
                    <label for="size" class="form-label d-block">Size:</label>
                    <div class="form-check">
                        <input class="form-check-input size-check" type="checkbox" name="product[size][]"
                            data-target="uploadS" value="S" id="size-s" <%=hasSize('S')?'checked': '' %>>
                        <label for="size-s">S</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input size-check" type="checkbox" name="product[size][]"
                            data-target="uploadM" value="M" id="size-m" <%=hasSize('M')?'checked': '' %>>
                        <label for="size-m">M</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input size-check" type="checkbox" name="product[size][]"
                            data-target="uploadL" value="L" id="size-l" <%=hasSize('L')?'checked': '' %>>
                        <label for="size-l">L</label>
                    </div>
                    <div class="form-check">
                        <input class="form-check-input size-check" type="checkbox" name="product[size][]"
                            data-target="uploadXL" value="XL" id="size-xl" <%=hasSize('XL')?'checked': '' %>>
                        <label for="size-xl">XL</label>
                    </div>
                </div>

                <div id="upload">
                    <label for="file" class="form-label">Upload files:</label>
                    <input class="form-control" type="file" name="designFileStandard" id="standard" multiple>
                    <ul class="file-list mt-3" id="file"></ul>
                </div>
                <div id="uploadS" class="<%= hasSize('S')?'':'d-none'%> mb-2">
                    <label for="file" class="form-label">Upload S files:</label>
                    <% if (filesFor('S').length) { %>
                        <ul class="file-list mt-3" id="file-S">
                            <%filesFor('S').forEach(f=> { %>
                                <li>
                                    <%=f.originalName|| f.key%>
                                </li>
                                <%})%>
                        </ul>
                        <%}%>
                            <input class="form-control fileUpload" type="file" name="designFileS" data-size="S"
                                multiple>
                </div>
                <div id="uploadM" class="<%= hasSize('M') ? '' : 'd-none'%> mb-2">
                    <label for="file" class="form-label">Upload M files:</label>
                    <% if (filesFor('M').length) { %>
                        <ul class="file-list mt-3" id="file-M">
                            <%filesFor('M').forEach(f=> { %>
                                <li>
                                    <%=f.originalName|| f.key%>
                                </li>
                                <%})%>
                        </ul>
                        <%}%>
                            <input class="form-control fileUpload" type="file" name="designFileM" data-size="M"
                                multiple>
                </div>

                <div id="uploadL" class="<%= hasSize('L') ? '' : 'd-none'%> mb-2">
                    <label for="file" class="form-label">Upload L files:</label>
                    <% if (filesFor('L').length) { %>
                        <ul class="file-list mt-3" id="file-L">
                            <%filesFor('L').forEach(f=> { %>
                                <li>
                                    <%=f.originalName|| f.key%>
                                </li>
                                <%})%>
                        </ul>
                        <%}%>
                            <input class="form-control fileUpload" type="file" name="designFileL" data-size="L"
                                multiple>
                </div>

                <div id="uploadXL" class="<%= hasSize('XL') ? '' : 'd-none'%> mb-2">
                    <label for="file" class="form-label">Upload XL files:</label>
                    <% if (filesFor('XL').length) { %>
                        <ul class="file-list mt-3" id="file-XL">
                            <%filesFor('XL').forEach(f=> { %>
                                <li>
                                    <%=f.originalName|| f.key%>
                                </li>
                                <%})%>
                        </ul>
                        <%}%>
                            <input class="form-control fileUpload" type="file" name="designFileXL" data-size="XL"
                                multiple>
                </div>

                <div id="imgGrid">
                    <div class="row">
                        <div class="d-flex flex-wrap border" id="imgTile">

                            <% product.images.forEach(function(img, i) { %>

                                <div class="smdiv mt-2 mb-3 ms-2 border mb-2 position-relative" data-existing="1"
                                    data-filename="<%=img.filename%>" draggable="true">
                                    <i class="delImg bi bi-x-circle position-absolute top-0 end-0 m-1"
                                        value="<%=img.filename%>"></i><img src="<%=img.editThumbnail%>"
                                        class="w-100 h-100 mb-3" alt="">
                                </div>
                                <%})%>
                                    <div id="addImg"
                                        class="smdiv mt-2 ms-2 border border-dark mb-2 d-flex justify-content-center align-items-center">
                                        <i class="bi bi-plus-square-dotted fs-1"></i>
                                    </div>
                                    <input type="file" id="imagePicker" name="image" accept="image/*" class="d-none"
                                        multiple>
                        </div>
                        <input type="hidden" name="product[imageOrder]" id="imageOrder">
                    </div>
                </div>
                <div class="mb-3">
                    <label for="description" class="form-label mt-3">Description</label>
                    <textarea class="form-control" style="height:300px;" name="product[description]" id="description"
                        required><%=product.description%></textarea>
                    <div class="valid-feedback">Looks good!
                    </div>
                </div>
                <div class="d-flex justify-content-center">
                    <button class="btn btn-info mb-3">Update Product</button>
                </div>
            </form>

            <script src="https://cdn.jsdelivr.net/npm/sortablejs@1.15.2/Sortable.min.js"></script>
            <script src="/js/addAndDrag.js"></script>
            <script src="/js/uploadToggle.js"></script>