<% layout('layouts/boilerplate') %>
    <div class="d-flex flex-column align-items-center">
        <div class="mt-5 pt-5">
            <h4>Thank you for shopping!</h4>
            <h4 class="mt-5">Order ID: <%=order.orderNumber%>
            </h4>
        </div>
        <div>Order placed: <%=new Date(order.createdAt).toLocaleString()%>
        </div>
        <div id="status" class="mt-5 pt-5">Order processing ...</div>
        <div id="downloadList">
        </div>
        <div class="mt-3">
            <%=order.email%>
        </div>
    </div>


    <script>
        const sessionId = '<%=sessionId%>';
        const status = document.getElementById('status');
        const downloadList = document.getElementById('downloadList');

        const sleep = (ms) => new Promise(r => setTimeout(r, ms));

        async function pollPaid(maxSeconds = 5) {
            const deadline = Date.now() + maxSeconds * 1000;
            while (Date.now() < deadline) {
                const result = await fetch(`/downloads/session/${encodeURIComponent(sessionId)}/status`);
                const data = await result.json();
                if (data.paid) return true;
                await sleep(1000);
            }
            return false;
        }

        async function loadFiles() {
            const result = await fetch(`/downloads/session/${encodeURIComponent(sessionId)}/files`);
            if (!result.ok) throw new Error('Download not available yet');
            return await result.json();
        }

        function renderLink(files) {
            downloadList.innerHTML = '';
            for (const file of files) {
                const li = document.createElement('li');
                li.className = 'd-flex justify-content-center align-items-center';

                const productDiv = document.createElement('div');
                productDiv.innerHTML = `<div>${file.name}</div>`;

                const a = document.createElement('a');
                a.className = 'btn btn-primary btn-sm';
                a.href = file.url;

                a.textContent = 'Download';

                li.appendChild(productDiv);
                li.append(a);
                downloadList.append(li);
            }
        }

        async function autoDownload(files) {
            if (!files.length) return;
            window.location.href = files[0].url;
        }

        (async () => {
            try {
                const paid = await pollPaid(5);
                if (!paid) {
                    status.className = 'alert alert-warning mt-5';
                    status.textContent = 'Payment processing. Please wait ...';
                    return;
                }

                status.className = 'alert alert-success';
                status.textContent = 'Payment confirmed. Generating download links...';

                const { files } = await loadFiles();
                renderLink(files);

                status.textContent = 'Download ready!';
                autoDownload(files);
            } catch (e) {
                status.className = 'alert alert-danger';
                status.textContent = 'Something went wrong. Please refresh the page';
            }
        })();
    </script>